name: TLA+ CircuitBreaker Model Check

on:
  push:
    branches: [ feature/spec/circuitbreaker-tla ]
  pull_request:
    branches: [ main ]

jobs:
  tlc:
    name: Run TLC (CircuitBreaker)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4


      - name: Run TLC (model check) via Docker
        run: |
          set -e
          mkdir -p tlc-output
          docker run --rm -t \
            -v "$PWD/docs/specs:/specs" \
            -v "$PWD/tlc-output:/tlc-output" \
            maxdiefenbach/tlaplus tlc \
              -cleanup -deadlock -workers 2 \
              -config /specs/circuit_breaker.cfg /specs/circuit_breaker.tla \
              2>&1 | tee tlc-output/tlc.log
          TLC_EXIT=${PIPESTATUS[0]:-${PIPESTATUS}}
          echo "$TLC_EXIT" > tlc-output/exitcode.txt
          if [ "$TLC_EXIT" -ne 0 ]; then
            echo "TLC finished with non-zero exit code: $TLC_EXIT"
            exit 1
          fi

      - name: Upload TLC logs
        uses: actions/upload-artifact@v4
        with:
          name: tlc-results
          path: tlc-output

      - name: Print summary
        if: success()
        run: |
          echo "TLC completed successfully. Artifacts: tlc-results"
